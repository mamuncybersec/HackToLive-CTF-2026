<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - HackToLive CTF</title>
    <link rel="icon" href="../images/logo.png" type="image/png">
    <style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Courier New',monospace;background:linear-gradient(135deg,#0d1f3c 0%,#1a2e5c 30%,#2a5298 60%,#1a3a52 100%);min-height:100vh;color:#fff;display:flex;align-items:center;justify-content:center}form{background:rgba(0,0,0,0.8);padding:20px;border-radius:10px;box-shadow:0 0 20px rgba(0,255,0,0.4);width:450px}h2{margin-bottom:15px;text-align:center;color:#00ff00}input[type=text],input[type=email],input[type=password]{width:100%;padding:8px;margin:5px 0;border:1px solid #00ff00;border-radius:4px;background:#222;color:#fff}label{display:block;margin-top:8px}button{width:100%;padding:10px;background:#00ff00;color:#000;border:none;border-radius:4px;font-weight:bold;cursor:pointer;transition:0.3s;margin-top:10px}button:hover{background:#00cc00}small{color:#f88}a{color:#00ff00;text-decoration:none;font-size:0.9em;display:block;text-align:center;margin-top:10px}.success{color:#00ff00;text-align:center}.info{color:#aaa;font-size:0.85em;margin-top:15px;text-align:center}</style>
</head>
<body>
<form id="resetForm">
    <h2>Forgot Password</h2>
    <div id="step1">
        <label>Username <input type="text" id="username" required></label>
        <div id="error" style="height:18px"><small></small></div>
        <button type="button" onclick="verifyUsername()">Verify Username</button>
        <div class="info">Enter your username to verify your account</div>
    </div>
    
    <div id="step2" style="display:none;">
        <label>Security Question: <span id="secQuestion"></span></label>
        <label>Answer <input type="text" id="answer" required></label>
        <div id="error2" style="height:18px"><small></small></div>
        <button type="button" onclick="verifyAnswer()">Verify Answer</button>
        <button type="button" onclick="backToStep1()">Back</button>
    </div>
    
    <div id="step3" style="display:none;">
        <label>New Password <input type="password" id="newPassword" required></label>
        <label>Confirm Password <input type="password" id="confirmPassword" required></label>
        <div id="error3" style="height:18px"><small></small></div>
        <button type="button" onclick="resetPassword()">Reset Password</button>
        <button type="button" onclick="backToStep1()">Back</button>
    </div>
    
    <div id="step4" style="display:none;text-align:center;">
        <p class="success">âœ“ Password Reset Successfully!</p>
        <p style="margin-top:10px;color:#aaa;">Your password has been updated.</p>
        <a href="login.html">Return to Login</a>
    </div>
    
    <a href="login.html">Back to Login</a>
</form>

<script>
let currentUsername = '';

function getRegistered(){
    return JSON.parse(localStorage.getItem('registeredUsers')||'{}');
}

function setRegistered(users){
    localStorage.setItem('registeredUsers', JSON.stringify(users));
}

function verifyUsername(){
    currentUsername = document.getElementById('username').value.trim();
    const error = document.getElementById('error').querySelector('small');
    const users = getRegistered();
    
    if(!currentUsername){
        error.textContent = 'Username cannot be empty';
        return;
    }
    
    if(!users[currentUsername]){
        error.textContent = 'Username not found';
        return;
    }
    
    if(!users[currentUsername].securityQuestion){
        error.textContent = 'Security question not set for this account';
        return;
    }
    
    document.getElementById('secQuestion').textContent = users[currentUsername].securityQuestion;
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
}

function verifyAnswer(){
    const answer = document.getElementById('answer').value.trim().toLowerCase();
    const error = document.getElementById('error2').querySelector('small');
    const users = getRegistered();
    
    if(!answer){
        error.textContent = 'Answer cannot be empty';
        return;
    }
    
    if(users[currentUsername].securityAnswer.toLowerCase() !== answer){
        error.textContent = 'Incorrect answer';
        return;
    }
    
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step3').style.display = 'block';
}

function resetPassword(){
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const error = document.getElementById('error3').querySelector('small');
    
    if(!newPassword || !confirmPassword){
        error.textContent = 'All fields required';
        return;
    }
    
    if(newPassword !== confirmPassword){
        error.textContent = 'Passwords do not match';
        return;
    }
    
    if(newPassword.length < 6){
        error.textContent = 'Password must be at least 6 characters';
        return;
    }
    
    const users = getRegistered();
    users[currentUsername].password = newPassword;
    setRegistered(users);
    
    document.getElementById('step3').style.display = 'none';
    document.getElementById('step4').style.display = 'block';
}

function backToStep1(){
    document.getElementById('username').value = '';
    document.getElementById('answer').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    document.getElementById('error').querySelector('small').textContent = '';
    document.getElementById('error2').querySelector('small').textContent = '';
    document.getElementById('error3').querySelector('small').textContent = '';
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step3').style.display = 'none';
    document.getElementById('step1').style.display = 'block';
}
</script>
</body>
</html>
